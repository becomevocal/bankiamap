/* Cargamos las librerías necesarias de forma asíncrona, en paralelo:
 * http://yepnopejs.com/
 */function dibujaMapa(){var e=L.map("mapa",{attributionControl:!1}).setView([40.46,-3.75],5);L.tileLayer("http://tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18}).addTo(e);var t=L.geoCsv(null,{onEachFeature:function(e,n){var r=e.properties[t.getPropertyName("idnum")],i=e.properties[t.getPropertyName("Dirección")],s=e.properties[t.getPropertyName("Código postal")],o=e.properties[t.getPropertyName("Localidad")],u=e.properties[t.getPropertyName("Teléfono")],a="https://graph.facebook.com/oauth/authorize?client_id=147793798720673&redirect_uri=http://foros.toqueabankia.net/entry/connect/facebook%3FTarget%3D%252Fcategories%252f"+r+"-"+u+"&scope=email,publish_stream",f="http://foros.toqueabankia.net/entry/register?Target=categories%252f"+r+"-"+u,l="http://foros.toqueabankia.net/categories%252f"+r+"-"+u,c="";c+='<b><a href="'+l+'" target="_blank">Oficina Nº '+r+"</a></b><br><br>",c+=i+"<br>",c+=s+" "+o+"<br>",c+="Tf: "+u+"<br><br>",c+='<div class="participa"><p>Pulsa en uno de los dos<br>botones para registrarte</p><p><a href="'+a+'" class="boton" target="_blank">facebook</a></p><p><a href="'+f+'" class="boton" target="_blank">e-mail</a></p></div>',n.bindPopup(c)},pointToLayer:function(e,t){return L.marker(t,{icon:L.icon({iconUrl:"images/marcador-bankia.png",shadowUrl:"images/marker-shadow.png",iconSize:[25,41],shadowSize:[41,41],shadowAnchor:[13,20]})})},firstLineTitles:!0});$.ajax({type:"GET",dataType:"text",url:"data/bankias.csv",error:function(){alert("No se pudieron cargar los datos")},success:function(n){t.addData(n);var r=new L.MarkerClusterGroup;r.addLayer(t),e.addLayer(r);var i=galleta.leer("posicionMapa");i==null?e.fitBounds(r.getBounds()):(i=i.split("&"),i.length==3&&(confirm("¿Quiere continuar navegando por el mapa desde el punto que lo dejó?")?e.setView([parseFloat(i[0]),parseFloat(i[1])],parseInt(i[2])):e.fitBounds(r.getBounds())))},complete:function(){$("#cargando").fadeOut("slow")}}),$("#localizame").click(function(t){e.locate(),$("#localizame").text("Localizando..."),e.on("locationfound",function(t){e.setView(t.latlng,15),$("#localizame").text("Bankias cercanos")})}),window.onbeforeunload=function(){var t=e.getCenter(),n=e.getZoom();galleta.nueva("posicionMapa",t.lat+"&"+t.lng+"&"+n,10)}}yepnope([{load:"http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js",complete:function(){window.jQuery||yepnope("lib/jquery/jquery.js")}},{load:"lib/leaflet/leaflet-bankia.js",complete:function(){dibujaMapa()}}]);var galleta={nueva:function(e,t,n){if(n){var r=new Date;r.setTime(r.getTime()+n*24*60*60*1e3);var i="; expires="+r.toGMTString()}else var i="";document.cookie=e+"="+t+i+"; path=/"},leer:function(e){var t=e+"=",n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return null},borrar:function(e){galleta.nueva(e,"",-1)}};